# Backend for IdealAQ sensor data monitoring app
This app was completed as part of [Full-stack open](fullstackopen.com/en/) course. Additionally, the created solution aims to serve as a useful tool for [IdealAQ](https://idealaq.com/) project with a potential to be the base or a case study for future production version of the web app.

The app is used as a backend for data visualisation app ass well as for the third parties who need to pull data generated by scientific measurement devices into their own systems.

## Prerequisites
To run locally, listed commands require docker engine and docker-compose tool to be installed.

The app can be run directly on the host machine. See commands in appropriate `Dockerfile` for more details how to run the app with Linux OS.

## Instructions
>**Note:** Instructions for querying data for third-parties are documented on the separate website: https://idealaq.github.io/cpcvis-data-docs/

To run the backend locally, run 
```bash
docker-compose -f ./docker-compose.dev.yml up
```
To open Swagger UI (for API documentation), visit http://127.0.0.1:8080/docs

To run tests, run while running backend in container: 
```bash
docker exec -it app-backend pytest .
```

To check linting, run while running backend in container:
```bash
docker exec -it app-backend flake8 .
```

To reformat files:
```bash
docker exec -it app-backend black .
```

## ENV Variables
> **WARNING:** The database used to run tests must be different from database used to run the app. Otherwise, all application data might ger corrupted or lost. 

| variable                      | description                                   | note                                                                        |
|-------------------------------|-----------------------------------------------|-----------------------------------------------------------------------------|
| **database**                  |                                               |                                                                             |
| `MONGODB_CONNECTION_URI`      | connection uri for the database               | example: `mongodb://root:example@mongo:27017/` _if run in docker container_ |
| `MONGODB_CONNECTION_URI_TEST` | connection uri for the database to run tests  | \*used only to run tests                                                    |
| `DB_NAME`                     | name of the database                          |                                                                             |
| `DB_NAME_TEST`                | name of the database used to run tests        | \*used only to run tests                                                    |
| **encryption**                |                                               |                                                                             |
| `SECRET_KEY`                  | secret key for JWT token (some random string) | command to generate a secret key can be found under this table              |
| `ALGORITHM`                   | algorithm used to encryption/decryption       | example: `HS256`                                                            |
| `ACCESS_TOKEN_EXPIRE_MINUTES` | JWT token expiration time in minutes          |                                                                             |
| **AWS SDK**                   |                                               |                                                                             |
| `AWS_ACCESS_KEY_ID`           | access key from AWS                           |                                                                             |
| `AWS_SECRET_ACCESS_KEY`       | secret access key from AWS                    |                                                                             |
| `AWS_REGION_NAME`             | AWS region name                               | example: `eu-central-1`                                                     |
| **administration**            |                                               |                                                                             |
| `ADMIN_EMAIL`                 | admin email                                   |                                                                             |
| `ADMIN_PASSWORD`              | admin password                                |                                                                             |



To generate `SECRET_KEY`, run
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

## Limitations
> The communication with the database is implemented with pymongo which causes blocking operations. To benefit from asynchronous FastAPI, transition to i.e. motor is needed.
> ***
> However, motor is built on top of pymongo and syntax is mostly compatible making the transition smooth.